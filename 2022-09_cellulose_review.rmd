---
title: "Cellulose synthesis"
author: "Leonard Blaschek"
date: '2022-09-17'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggtext)
library(ggrepel)
library(showtext)

## import Helvetica ####
font_add(
  "Helvetica",
  regular = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Lt.otf",
  italic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-LtIt.otf",
  bold = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-Bd.otf",
  bolditalic = "/prop_fonts/01. Helvetica   [1957 - Max Miedinger]/HelveticaNeueLTStd-BdIt.otf"
)
showtext_auto()

#### generating plot theme ####
theme_leo <- function(base_size = 6,
                      base_family = "Helvetica") {
  theme_minimal(
    base_size = base_size,
    base_family = base_family
  ) %+replace%
    theme(
      strip.text = element_markdown(
        hjust = 0,
        # face = "italic"
      ),
      axis.ticks = element_line(
        size = 0.125,
        lineend = "square",
        color = "black"
      ),
      axis.text.x = element_markdown(
        size = 6,
        colour = "black",
        margin = margin(1, 1, 1, 1)
      ),
      axis.text.y = element_markdown(
        colour = "black",
        size = 6,
        angle = 0,
        vjust = 0.5,
        hjust = 1,
        margin = margin(1, 1, 1, 1)
      ),
      axis.title = element_markdown(
        colour = "black",
        size = 6
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", size = 0.25),
      panel.spacing = unit(1.5, "mm"),
      legend.position = "none",
      legend.text = element_text(size = 6),
      legend.key.height = unit(4, "mm"),
      plot.title = element_markdown(
        size = 6,
        hjust = 0
      ),
      complete = TRUE
    )
}

pal_ostwald_disc <- c(
  "#275d95",
  "#e8c245",
  "#d25952"
)

# convenience figure size functions
ggtext_size <- 6 / (14 / 5)
cm_size <- function(x) x / 2.54
twocol <- 18 / 2.54
onehalfcol <- 14 / 2.54
onecol <- 9 / 2.54
```

# CSC velocity to cellulose content regression

## Load data

```{r}
velo_data <- read_tsv('/home/leonard/Dropbox/2022_molplant_review/velocity_cellulose.tsv') %>% 
  mutate(colour = case_when(str_detect(`mutated gene`, 'CESA') ~ 'CESA',
                               perturbation == 'WT' ~ 'WT',
                               TRUE ~ 'accessory protein'),
         gene_type = case_when(str_detect(`mutated gene`, 'CESA') ~ 'CESA',
                               TRUE ~ 'accessory protein'),
         face = case_when(`perturbation type` == 'mutation' ~ 'italic',
                          TRUE ~ 'plain'),
         CESA = case_when(gene_type =='CESA' ~ `mutated gene`,
                          TRUE ~ 'accessory protein')) %>% 
  distinct(perturbation, .keep_all = TRUE) %>% 
  filter(`perturbation type` != 'drug')
```

## Calulate regression

```{r}
cesa_data <- velo_data %>% filter(perturbation == 'none')
```


## Plot regression

```{r}
velo_plot <- ggplot(velo_data,
                    aes(x = `velocity [% of WT]`,
                        y = `cellulose [% of WT]`,
                        colour = colour)) +
  geom_point(aes(shape = CESA)) +
  geom_smooth(
    aes(colour = gene_type,
        linetype = gene_type),
    method = 'lm',
    se = FALSE) +
  geom_label_repel(
    data = velo_data %>% filter(gene_type != 'CESA'),
    aes(
      label = `perturbation`,
      fontface = face),
    size = ggtext_size,
    label.size = NA,
    label.r = unit(0, 'mm'),
    label.padding = unit(0.5, 'mm'),
    fill = rgb(1, 1, 1, 0.75)
    ) +
  scale_colour_manual(values = c(pal_ostwald_disc[c(1,3)], 'black'), guide = 'none') +
  scale_linetype(guide = 'none') +
  scale_shape(name = 'Mutated gene') +
  # scale_y_continuous(limits = c(60, 115)) +
  theme_leo() +
  theme(legend.position = c(0.2, 0.85))

pdf("velocity_cellulose.pdf", height = onecol, width = onecol)
velo_plot
dev.off()
```


